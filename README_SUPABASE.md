<p align="center">
<img src="https://user-images.githubusercontent.com/8291514/213727234-cda046d6-28c6-491a-b284-b86c5cede25d.png#gh-light-mode-only">
<img src="https://user-images.githubusercontent.com/8291514/213727225-56186826-bee8-43b5-9b15-86e839d89393.png#gh-dark-mode-only">
</p>

# Configuration

To simplify the authorization we are going to use custom claims in supabase.
To do this, it is necessary to create a table called user_roles
which will have at least 3 fields:
id, user_id, role

We will need to create a function that acts as a hook at the moment of creating the JWT
this function we will call it custom_access_token_hook

We are going to need a function that acts as a trigger at the moment of entering a user to the auth.users table that creates the user with his role in user_roles.

## Creation of the role table

You can always create the table from the visual. In fact, it is the recommended way to do it,
but if you want to do it by means of SQL I leave it to you below
```
create table public.user_roles (
  id        bigint generated by default as identity primary key,
  user_id   uuid references not null,
  role      varchar not null,
  unique (user_id, role)
);
```

## Creation of the Trigger

Let's create the trigger function:
```
create function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.user_roles (user_id, role)
  values (new.id, 'user');
  return new;
end;
$$;
```

We are going to associate the trigger at the moment of insertion in the `auth.users` table
```
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```

## Creation of the hook

```
create or replace function public.custom_access_token_hook(event jsonb)
returns jsonb
language plpgsql
stable
as $$
  declare
    claims jsonb;
    user_role varchar;
  begin
    -- Fetch the user role in the user_roles table
    select role into user_role from public.user_roles where user_id = (event->>'user_id')::uuid;

    claims := event->'claims';

    if user_role is not null then
      -- Set the claim
      claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
    else
      claims := jsonb_set(claims, '{user_role}', 'null');
    end if;

    -- Update the 'claims' object in the original event
    event := jsonb_set(event, '{claims}', claims);

    -- Return the modified or original event
    return event;
  end;
$$;

grant usage on schema public to supabase_auth_admin;

grant execute
  on function public.custom_access_token_hook
  to supabase_auth_admin;

revoke execute
  on function public.custom_access_token_hook
  from authenticated, anon, public;

grant all
  on table public.user_roles
to supabase_auth_admin;

revoke all
  on table public.user_roles
  from authenticated, anon, public;

create policy "Allow auth admin to read user roles" ON public.user_roles
as permissive for select
to supabase_auth_admin
using (true)
```

Grant permissions:
```
grant execute
  on function public.custom_access_token_hook
  to supabase_auth_admin;

grant usage on schema public to supabase_auth_admin;
```

Once you have created the function for the hook, go to `Authentication -> Hooks -> Add Hook` and associate the function to `Customize Access Token (JWT) Claims hook`.
and associate the function to `Customize Access Token (JWT) Claims hook`.
